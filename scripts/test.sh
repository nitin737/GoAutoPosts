#!/bin/bash

# Test script for go-daily publisher
# This script validates the setup without posting to Instagram

set -e

echo "ğŸ§ª Testing Go Daily Publisher..."
echo ""

# Check if we're in the right directory
if [ ! -f "go.mod" ]; then
    echo "âŒ Error: Must be run from root directory"
    exit 1
fi

# Check dependencies
echo "ğŸ“¦ Checking dependencies..."
go mod verify
echo "âœ… Dependencies verified"
echo ""

# Validate data
echo "ğŸ“Š Validating library data..."
go run scripts/validate_data.go data/libraries.json
echo ""

# Check environment variables (optional for test)
echo "ğŸ”§ Checking environment configuration..."
if [ -f ".env" ]; then
    echo "âœ… .env file found"
else
    echo "âš ï¸  .env file not found (using defaults)"
fi
echo ""

# Build the application
echo "ğŸ”¨ Building application..."
go build -o bin/publisher cmd/publisher/main.go
echo "âœ… Build successful"
echo ""

# Check binary
echo "ğŸ“¦ Binary info:"
ls -lh bin/publisher
echo ""

# Check base image
echo "ğŸ–¼ï¸  Checking base image..."
if [ -f "internal/image/assets/base.png" ]; then
    echo "âœ… Base image found"
    ls -lh internal/image/assets/base.png
else
    echo "âŒ Base image not found"
    exit 1
fi
echo ""

# Test library selection (dry run)
echo "ğŸ² Testing library selection..."
echo "   Libraries available: $(jq 'length' data/libraries.json)"
echo "   Posted history: $(jq 'length' data/posted.json)"
echo ""

# Test hashtag generation
echo "#ï¸âƒ£  Testing hashtag generation..."
echo "   Base hashtags configured: golang, go, programming, coding, developer, software, opensource, tech"
echo ""

# Verify all components are importable
echo "ğŸ” Verifying package structure..."
go list ./... | grep -v vendor
echo "âœ… All packages valid"
echo ""

echo "âœ… All tests passed!"
echo ""
echo "ğŸ“ Next steps:"
echo "   1. Set up Instagram credentials in .env"
echo "   2. Add more libraries to data/libraries.json"
echo "   3. Run: make run (to test full workflow)"
echo ""
